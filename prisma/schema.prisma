generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum GemType {
  ESMERALDA
  RUBI
  SAFIRA
  DIAMANTE
}

enum ProjectStatus {
  ATIVO
  INATIVO
}

model User {
  id                String   @id @default(cuid())
  name              String
  email             String   @unique
  password          String
  role              Role     @default(CLIENT)
  isActive          Boolean  @default(true)
  licenseExpiresAt  DateTime?
  lastLoginAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  projects          ClientProject[]
  auditLogs         UserAuditLog[]
}

enum Role {
  ADMIN
  CLIENT
}

model Template {
  id          String    @id @default(cuid())
  name        String
  description String?
  isActive    Boolean   @default(true)
  stages      TemplateStage[]
  tasks       Task[]
  projects    ClientProject[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model TemplateStage {
  id          String    @id @default(cuid())
  name        String
  description String?
  order       Int
  gemType     GemType   @default(ESMERALDA)
  template    Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId  String
  tasks       Task[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  order       Int       @default(0)
  stage       TemplateStage? @relation(fields: [stageId], references: [id], onDelete: Cascade)
  stageId     String?
  template    Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId  String
  subtasks    Subtask[]
  clientAnswers ClientTaskAnswer[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Subtask {
  id        String @id @default(cuid())
  description String
  task      Task   @relation(fields: [taskId], references: [id])
  taskId    String
  clientAnswers ClientSubtaskAnswer[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClientProject {
  id              String     @id @default(cuid())
  name            String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  template        Template   @relation(fields: [templateId], references: [id])
  templateId      String
  progress        Float      @default(0)
  currentGem      GemType?
  status          ProjectStatus @default(ATIVO)
  price           String?
  currency        String?    @default("BRL")
  saleStartDate   DateTime?
  links           Json?
  projectStages   ProjectStage[]
  projectTasks    ProjectTask[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model ProjectStage {
  id          String    @id @default(cuid())
  name        String
  description String?
  order       Int
  gemType     GemType   @default(ESMERALDA)
  project     ClientProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  tasks       ProjectTask[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ProjectTask {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int       @default(0)
  completed   Boolean   @default(false)
  status      TaskStatus @default(TODO)
  link        String?
  stage       ProjectStage? @relation(fields: [stageId], references: [id], onDelete: Cascade)
  stageId     String?
  project     ClientProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  subtasks    ProjectSubtask[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ProjectSubtask {
  id          String   @id @default(cuid())
  description String
  answer      String?
  completed   Boolean  @default(false)
  link        String?
  task        ProjectTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ClientTaskAnswer {
  id        String   @id @default(cuid())
  projectId String
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClientSubtaskAnswer {
  id        String   @id @default(cuid())
  projectId String
  subtask   Subtask  @relation(fields: [subtaskId], references: [id])
  subtaskId String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Settings {
  id                        String   @id @default(cuid())
  key                       String   @unique
  value                     String
  description               String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_ACTIVATED
  USER_DEACTIVATED
  USER_DELETED
  PASSWORD_CHANGED
  LICENSE_EXTENDED
  LICENSE_EXPIRED
  ROLE_CHANGED
}

enum AuditSource {
  ADMIN_PANEL
  WEBHOOK
  SYSTEM
  SELF
}

model UserAuditLog {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      AuditAction
  source      AuditSource
  performedBy String?     // ID do admin que realizou a ação, ou null se foi sistema/webhook
  details     String?     // JSON com detalhes adicionais (campo alterado, valor anterior, etc)
  ipAddress   String?
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([createdAt])
}


